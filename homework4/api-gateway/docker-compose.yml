version: '3.8'

services:
  postgres-orders:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: microservice
      POSTGRES_PASSWORD: password
    volumes:
      - postgres-orders-data:/var/lib/postgresql/data

  postgres-payments:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: microservice
      POSTGRES_PASSWORD: password
    volumes:
      - postgres-payments-data:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password
    ports:
      - "15672:15672"
      - "5672:5672"

  orders-service:
    image: python:3.11-slim
    command: >
      bash -c "
      pip install fastapi uvicorn &&
      python -c '
from fastapi import FastAPI
from pydantic import BaseModel
import uvicorn

app = FastAPI()

class OrderCreate(BaseModel):
    user_id: str
    amount: float
    description: str

@app.post(\"/api/orders\")
async def create_order(order: OrderCreate):
    return {\"message\": \"Order created\", \"order_id\": \"test-123\", \"status\": \"NEW\"}

@app.get(\"/api/orders\")
async def get_orders(user_id: str):
    return [{\"id\": \"test-123\", \"user_id\": user_id, \"amount\": 999.99, \"status\": \"NEW\"}]

@app.get(\"/health\")
async def health():
    return {\"status\": \"ok\"}

if __name__ == \"__main__\":
    uvicorn.run(app, host=\"0.0.0.0\", port=8080)
      '"
    ports:
      - "8081:8080"

  payments-service:
    image: python:3.11-slim
    command: >
      bash -c "
      pip install fastapi uvicorn &&
      python -c '
from fastapi import FastAPI
from pydantic import BaseModel
import uvicorn

app = FastAPI()

class AccountCreate(BaseModel):
    user_id: str

class Deposit(BaseModel):
    amount: float

@app.post(\"/api/accounts\")
async def create_account(account: AccountCreate):
    return {\"message\": \"Account created\", \"user_id\": account.user_id, \"balance\": 0}

@app.post(\"/api/accounts/{user_id}/deposit\")
async def deposit(user_id: str, deposit: Deposit):
    return {\"message\": \"Deposit successful\", \"user_id\": user_id, \"balance\": deposit.amount}

@app.get(\"/api/accounts/{user_id}/balance\")
async def get_balance(user_id: str):
    return {\"user_id\": user_id, \"balance\": 1500.0}

@app.get(\"/health\")
async def health():
    return {\"status\": \"ok\"}

if __name__ == \"__main__\":
    uvicorn.run(app, host=\"0.0.0.0\", port=8080)
      '"
    ports:
      - "8082:8080"

  websocket-service:
    image: python:3.11-slim
    command: >
      bash -c "
      pip install websockets &&
      python -c '
import asyncio
import websockets
import json

async def handler(websocket, path):
    print(\"Client connected\")
    try:
        async for message in websocket:
            data = json.loads(message)
            if data.get(\"type\") == \"subscribe\" and data.get(\"order_id\"):
                await websocket.send(json.dumps({
                    \"type\": \"subscribed\",
                    \"order_id\": data[\"order_id\"]
                }))
                await asyncio.sleep(3)
                await websocket.send(json.dumps({
                    \"type\": \"order_update\",
                    \"order_id\": data[\"order_id\"],
                    \"status\": \"FINISHED\",
                    \"message\": \"Payment successful\"
                }))
    except websockets.exceptions.ConnectionClosed:
        print(\"Client disconnected\")

async def main():
    async with websockets.serve(handler, \"0.0.0.0\", 8080):
        print(\"WebSocket server started on port 8080\")
        await asyncio.Future()

asyncio.run(main())
      '"
    ports:
      - "8083:8080"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://localhost:80
      REACT_APP_WS_URL: ws://localhost/ws

  api-gateway:
    build:
      context: ./api-gateway
    ports:
      - "80:80"

volumes:
  postgres-orders-data:
  postgres-payments-data: